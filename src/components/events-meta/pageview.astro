---
const { eventName = "PageView", customData = {} } = Astro.props;
---

<!-- Contenedor para inyectar los datos -->
<div id="astro-event-data"
     data-event-name={eventName}
     data-custom-data={JSON.stringify(customData)}>
</div>

<script is:inline>
document.addEventListener("DOMContentLoaded", () => {
  try {
    const el = document.getElementById("astro-event-data");
    const eventNameLiteral = el.dataset.eventName;
    const eventDataLiteral = JSON.parse(el.dataset.customData);

    console.log("Disparando PageView", eventNameLiteral, eventDataLiteral);

    function getCookie(name) {
      const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return match ? match[2] : null;
    }

    // Pixel del navegador
    if (window.fbq) {
      fbq("track", eventNameLiteral, eventDataLiteral);
      console.log("Evento Pixel disparado:", eventNameLiteral, eventDataLiteral);
    }

    // CAPI
    fetch("https://stroit-metaapi.soporte-draw.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json", Accept: "application/json" },
      body: JSON.stringify({
        event_name: eventNameLiteral,
        event_time: Math.floor(Date.now() / 1000),
        action_source: "website",
        event_source_url: window.location.href,
        user_data: {
          client_ip_address: "NO_HASH_IP",
          client_user_agent: navigator.userAgent,
          fbp: getCookie("_fbp"),
          fbc: getCookie("_fbc"),
        },
        custom_data: eventDataLiteral,
      }),
    }).catch(err => console.error("Error CAPI PageView:", err));

  } catch (err) {
    console.error("Error al disparar PageView:", err);
  }
});
</script>
